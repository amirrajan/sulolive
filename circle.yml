machine:
  services:
    - docker
  environment:
    CLJ_TEST_REPORT_FILE: $CIRCLE_TEST_REPORTS/lein-test/budget-clj-tests.xml
    CLJS_BUILD_ID: release
    AWS_DEFAULT_REGION: us-east-1
    DOCKER_IMAGE: petterik/jourmoney:$CIRCLE_SHA1
    TIMBRE_LEVEL: :error

dependencies:
  pre:
    - pip install awscli
    - lein deps
    - lein uberjar
    - docker build -t $DOCKER_IMAGE .

test:
  override:
    - mkdir -p "$CLJ_TEST_REPORT_FILE"
    - rmdir "$CLJ_TEST_REPORT_FILE"
    - lein trampoline test-out junit "$CLJ_TEST_REPORT_FILE"
    - ./scripts/run-cljs-tests.sh
  post:
    - docker run -d -e "PORT=8080" -e "CLJS_BUILD_ID=$CLJS_BUILD_ID" -e "SESSION_COOKIE_NAME=$SESSION_COOKIE_NAME" -e "SESSION_COOKIE_STORE_KEY=$SESSION_COOKIE_STORE_KEY" -p 8080:8080 $DOCKER_IMAGE; sleep 15
    - docker ps -l
    - docker ps -l -q | xargs docker logs
    - wget -O- --retry-connrefused -t 10 http://localhost:8080
    
deployment:
  staging:
    branch: master
    heroku:
      appname: jourbudget
  elasticbeanstalk:
    branch: production
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - ./scripts/deploy.sh "$CIRCLE_SHA1" "$DOCKER_IMAGE"

