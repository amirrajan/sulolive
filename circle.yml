machine:
  node:
    version: 4.2.2
  java:
    version: openjdk8
  services:
    - docker
  environment:
    _JAVA_OPTIONS: "-Xms512m -Xmx2048m"
    CLJ_TEST_REPORT_FILE: $CIRCLE_TEST_REPORTS/lein-test/budget-clj-tests.xml
    CLJS_BUILD_ID: release
    AWS_DEFAULT_REGION: us-east-1
    DOCKER_IMAGE: sulolive/sulo:$CIRCLE_SHA1
    TIMBRE_LEVEL: :info
    PORT: 8080

dependencies:
  cache_directories:
    - sulo-style/node_modules
    - sulo-style/bower_components
    - /opt/circleci/nodejs/v4.2.2
  pre:
    - pip install awscli
    - npm install -g npm
    - npm install -g bower
    - npm install -g foundation-cli
  override:
    - lein all-deps
    - lein with-profile web deps
    - lein with-profile mobile deps

test:
  override:
    - ./scripts/run-cljs-tests.sh
  post:
    - lein clean
    - lein uberjar
    - docker build -t $DOCKER_IMAGE .
    - docker run -d -e "PORT=$PORT" -e "CLJS_BUILD_ID=$CLJS_BUILD_ID" -e "SESSION_COOKIE_NAME=$SESSION_COOKIE_NAME" -e "SESSION_COOKIE_STORE_KEY=$SESSION_COOKIE_STORE_KEY" -p $PORT:$PORT $DOCKER_IMAGE; sleep 15
    - docker ps -l
    - docker ps -l -q | xargs docker logs
    - ./scripts/run-docker-img-test.sh localhost $PORT
    - docker ps -l -q | xargs docker logs
    
deployment:
  staging:
    branch: master
    heroku:
      appname: sulo-master
  elasticbeanstalk:
    branch: production
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - ./scripts/deploy.sh "$CIRCLE_SHA1" "$DOCKER_IMAGE"

