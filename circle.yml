machine:
  node:
    version: 4.2.2
  ruby:
    version: 2.3.1
  services:
    - docker
  environment:
    CLJ_TEST_REPORT_FILE: $CIRCLE_TEST_REPORTS/lein-test/budget-clj-tests.xml
    CLJS_BUILD_ID: release
    AWS_DEFAULT_REGION: us-east-1
    DOCKER_IMAGE: eponai/jourmoney:$CIRCLE_SHA1
    TIMBRE_LEVEL: :info
    PORT: 8080

dependencies:
  pre:
    - pip install awscli
    - npm install -g npm
    - gem install cocoapods --version '1.0.1'
  override:
    - lein all-deps

test:
  override:
    - mkdir -p "$CLJ_TEST_REPORT_FILE"
    - rmdir "$CLJ_TEST_REPORT_FILE"
    - lein trampoline test-out junit "$CLJ_TEST_REPORT_FILE"
    - ./scripts/run-cljs-tests.sh
  post:
    - lein clean
    - lein uberjar
    - docker build -t $DOCKER_IMAGE .
    - docker run -d -e "PORT=$PORT" -e "CLJS_BUILD_ID=$CLJS_BUILD_ID" -e "SESSION_COOKIE_NAME=$SESSION_COOKIE_NAME" -e "SESSION_COOKIE_STORE_KEY=$SESSION_COOKIE_STORE_KEY" -p $PORT:$PORT $DOCKER_IMAGE; sleep 15
    - docker ps -l
    - docker ps -l -q | xargs docker logs
    - ./scripts/run-docker-img-test.sh localhost $PORT
    
deployment:
  staging:
    branch: master
    heroku:
      appname: jourbudget
  elasticbeanstalk:
    branch: production
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - ./scripts/deploy.sh "$CIRCLE_SHA1" "$DOCKER_IMAGE"

